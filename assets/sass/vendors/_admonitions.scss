// _admonitions.scss
// Hugo Admonitions Styling with Configurable Theme Colors and Dark Mode Selector

// =============================================================================
// --- User Customization Hook ---
// =============================================================================
// Import user-defined variables.
// This imported file should define variables directly (e.g., $admonition-light-bg: #mycolor;)
// or define override maps like $admonition-colors-overrides.
@import "admonitions-user-settings";

// =============================================================================
// --- Helper Function ---
// =============================================================================
@function hex-to-rgb($color) {
    @return red($color), green($color), blue($color);
}

// =============================================================================
// --- Configuration (with !default) ---
// =============================================================================

// --- Dark Mode Activation ---
// Define the CSS selector(s) used by the theme to indicate dark mode.
$admonition-dark-selector: (
    'html[data-theme="dark"]',
    'body[data-theme="dark"]',
    'html[data-bs-theme="dark"]',
    'html[data-scheme="dark"]',
    'body[data-scheme="dark"]',
    'html[data-color-mode="dark"]',
    'body[data-color-mode="dark"]',
    "body.dark",
    "body.dark-mode",
    "body.dark-theme",
    "body.theme-dark",
    "html.dark",
    "html.dark-mode",
    "html.dark-theme",
    "html.theme-dark"
    ) !default;

// --- Theme Colors ---
// Define the colors used for admonition elements in both light and dark modes.

// Light Mode Colors
$admonition-light-bg: var(--color-background) !default; // Content background
$admonition-light-text: var(--color-text) !default; // Content text
$admonition-light-code-bg: #f5f5f5 !default; // Inline code & code block background
$admonition-light-code-text: #24292e !default; // Inline code & code block text
$admonition-light-blockquote-border: #e0e0e0 !default; // Blockquote left border

// Dark Mode Colors
$admonition-dark-bg: var(--color-background) !default; // Content background
$admonition-dark-text: var(--color-text) !default; // Content text
$admonition-dark-code-bg: #313244 !default; // Inline code & code block background
$admonition-dark-code-text: #cdd6f4 !default; // Inline code & code block text
$admonition-dark-blockquote-border: #45475a !default; // Blockquote left border

// --- Header Text Colors (Per-Type Overrides) ---
// Use the map to override header colors for specific admonition types.
// This takes precedence over the default theme color.
// Example: (danger: #ffffff, warning: #5c3a00)
$admonition-light-header-text-overrides: (
    ) !default;
$admonition-dark-header-text-overrides: (
    ) !default;

// --- Header Background Opacity ---
// Controls the opacity of the background color tint applied to the whole admonition block.
// Value should be between 0 (transparent) and 1 (opaque).
$admonition-light-header-bg-opacity: 0.0 !default; // Opacity for light mode background tint
$admonition-dark-header-bg-opacity: 0.0 !default; // Opacity for dark mode background tint

// User-provided map for overriding/adding specific admonition type colors.
// Users should define '$admonition-colors-overrides' in their custom-variables file.
$admonition-colors-overrides: (
    ) !default;

// User-provided map for overriding admonition type colors in dark mode.
// If not specified, light mode colors will be used.
$admonition-dark-colors-overrides: (
    ) !default;

$admonition-colors-base: (
    abstract: #209fb5,
    caution: #e64553,
    code: #7287fd,
    conclusion: #dd7878,
    danger: #fe640b,
    error: #d20f39,
    example: #dc8a78,
    experiment: #51bb2a,
    goal: #e64553,
    // Note: Same as caution by default
    idea: #df8e1d,
    important: #7d4dda,
    info: #04a5e5,
    memo: #e64553,
    // Note: Same as caution by default
    note: var(--color-primary),
    // notify: #0d48bd,
    // notify: #7d4dda,
    notify: var(--color-text),
    question: #179299,
    quote: #7287fd,
    success: #40a02b,
    task: #8839ef,
    tip: #179299,
    warning: #df8e1d,
    ) !default;

// Merge base colors with user overrides to get the final color map.
// User's overrides will take precedence.
$admonition-colors: map-merge($admonition-colors-base,
        $admonition-colors-overrides
);

// Dark mode colors: use light mode colors as default, then apply dark mode overrides
$admonition-dark-colors: map-merge($admonition-colors,
        $admonition-dark-colors-overrides);

// =============================================================================
// --- CSS Variables ---
// =============================================================================

:root {
    --adm-bg: #{$admonition-light-bg};
    --adm-text: #{$admonition-light-text};
    --adm-code-bg: #{$admonition-light-code-bg};
    --adm-code-text: #{$admonition-light-code-text};
    --adm-blockquote-border: #{$admonition-light-blockquote-border};
    --adm-header-bg-opacity: #{$admonition-light-header-bg-opacity};

    @each $type, $color in $admonition-colors {
        --adm-#{$type}: #{$color};
        // --adm-#{$type}-rgb: #{hex-to-rgb($color)};

        $override-color: map-get($admonition-light-header-text-overrides, $type);

        @if $override-color {
            --adm-#{$type}-header: #{$override-color};
        }
    }
}

#{join($admonition-dark-selector, ", ")} {
    --adm-bg: #{$admonition-dark-bg};
    --adm-text: #{$admonition-dark-text};
    --adm-code-bg: #{$admonition-dark-code-bg};
    --adm-code-text: #{$admonition-dark-code-text};
    --adm-blockquote-border: #{$admonition-dark-blockquote-border};
    --adm-header-bg-opacity: #{$admonition-dark-header-bg-opacity};

    @each $type, $color in $admonition-dark-colors {
        --adm-#{$type}: #{$color};
        // --adm-#{$type}-rgb: #{hex-to-rgb($color)};
    }

    @each $type, $override-color in $admonition-dark-header-text-overrides {
        --adm-#{$type}-header: #{$override-color};
    }
}

// =============================================================================
// --- Base Admonition Structure & Styles ---
// =============================================================================

.admonition {
    margin: 1rem 0;
    border-radius: 0px;
    box-shadow: 0;
    transition: box-shadow 0.3s ease;
    overflow: hidden;
    position: relative;
}

.admonition-header {
    padding: 0.5rem 1rem;
    display: flex;
    align-items: center;
    font-weight: 600;
    font-size: inherit;
    border-radius: 0px 00px 0 0;
    transition: color 0.3s ease;
    position: relative;
    z-index: 1;
    color: var(--adm-type-header, var(--adm-type-color));

    svg {
        width: 1.1em;
        height: 1.1em;
        margin-right: 0.5rem;
        fill: currentColor;
        flex-shrink: 0;
        transition: fill 0.3s ease;
    }

    span {
        flex-grow: 1;
    }
}

.admonition-content {
    padding: 1rem;
    border-radius: 0 0 0px 0px;
    transition: background-color 0.3s ease, color 0.3s ease;
    position: relative;
    background-color: var(--adm-bg);
    color: var(--adm-text);

    // Basic structure/spacing for nested elements
    p {
        margin-top: 0;
        margin-bottom: 0.75rem;
    }

    ul,
    ol {
        margin-top: 0;
        margin-bottom: 0.75rem;
        padding-left: 1.5rem;
    }

    blockquote {
        margin: 0 0 0.75rem 0;
        padding-left: 1rem;
        border-left: 3px solid var(--adm-blockquote-border);
        font-style: italic;
        transition: border-color 0.3s ease, color 0.3s ease; // Keep transitions
        color: inherit;
    }

    code:not(pre > code) {
        // Inline code, excluding code blocks
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-size: 0.9em;
        transition: background-color 0.3s ease, color 0.3s ease;
        background-color: var(--adm-code-bg);
        color: var(--adm-code-text);
    }

    pre {
        margin: 0 0 0.75rem 0;
        padding: 0.8rem 1rem;
        border-radius: 3px;
        overflow-x: auto;
        transition: background-color 0.3s ease; // Keep transitions
        background-color: var(--adm-code-bg);

        code {
            // Code inside pre
            background-color: transparent !important;
            color: var(--adm-code-text);
            padding: 0;
            font-size: inherit;
            border-radius: 0;
        }
    }

    // Remove bottom margin from the last child inside content area
    &>*:last-child {
        margin-bottom: 0;
    }
}

// =============================================================================
// --- Generate Admonition Type Styles ---
// =============================================================================
@each $type, $color in $admonition-colors {
    .admonition.#{$type} {
        border-left: .25em solid var(--adm-#{$type});
        background-color: rgba(var(--adm-#{$type}-rgb), var(--adm-header-bg-opacity));
        --adm-type-color: var(--adm-#{$type});
        --adm-type-header: var(--adm-#{$type}-header, var(--adm-#{$type}));
    }
}

// =============================================================================
// --- Custom Admonition Folding Marker ---
// =============================================================================
.admonition {

    // Target the summary element only when it's a direct child of a foldable admonition (<details>)
    &>summary {
        list-style: none;

        /* For Firefox */
        &::-webkit-details-marker {
            /* For Chrome, Safari, Edge */
            display: none;
        }

        cursor: pointer;
        position: relative; // Ensures it can stack if needed
        z-index: 2; // Position above content background if overlapping occurs

        &::after {
            content: ">";
            /* Use a simple chevron character */
            display: inline-block;
            /* Allows transforms and margins */
            font-weight: bold;
            // Use margin-left to add space BEFORE the indicator (after the text)
            margin-left: 0.6em;
            /* Adjust spacing as needed */
            transition: transform 0.2s ease-in-out;
            /* Smooth rotation */
            transform-origin: center;
            /* Rotate around the center */
            // Inherit the color from the summary text (which gets set by header color rule)
            color: currentColor;
            // Optional: Adjust vertical alignment if needed
            // vertical-align: middle;
        }

        // Prevent the title span from growing and pushing the ::after pseudo-element
        // This should already be handled by the flex properties in .admonition-header
        // & > span { flex-grow: 0; } // Re-add if marker gets pushed
    }

    &[open]>summary::after {
        transform: rotate(90deg);
        /* Rotate the chevron down */
    }
}